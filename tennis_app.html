<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>テニスダブルススコアアプリ</title>
    <!-- Tailwind CSSのCDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 900px;
        }
        .main-card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            transition: transform 0.1s ease-in-out, background-color 0.1s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .selected-btn {
            border: 2px solid #3b82f6;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <!-- Main application container -->
    </div>

    <script>
        // グローバル変数としてアプリの状態を管理
        const state = {
            currentPage: 'home', // 'home', 'setup', 'match', 'history', 'analysis'
            matchData: null,
            history: [],
            players: {
                team1: ['', ''],
                team2: ['', '']
            },
            score: {
                sets: [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0]],
                games: [0, 0],
                points: ['0', '0']
            },
            currentShot: null,
            currentPointWinner: null
        };

        const pages = {
            home: `
                <div class="main-card p-6 md:p-12 text-center space-y-8">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-800 tracking-tight">テニススコアトラッカー</h1>
                    <p class="text-lg text-gray-600">あなたのテニスダブルスの試合を記録して分析しましょう。</p>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4 mt-8">
                        <button onclick="navigate('setup')" class="btn bg-blue-600 text-white font-bold py-4 px-8 rounded-full shadow-lg hover:bg-blue-700 w-full">
                            新しい試合を開始
                        </button>
                        <button onclick="navigate('history')" class="btn bg-gray-200 text-gray-800 font-bold py-4 px-8 rounded-full shadow-lg hover:bg-gray-300 w-full">
                            試合履歴を見る
                        </button>
                    </div>
                </div>
            `,
            setup: `
                <div class="main-card p-6 md:p-8 space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center">試合設定</h2>
                    <form id="setupForm" class="space-y-4">
                        <!-- 日付 -->
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">日にち</label>
                            <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- 試合名 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="tournament" class="block text-sm font-medium text-gray-700">大会名</label>
                                <input type="text" id="tournament" name="tournament" placeholder="〇〇大会" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="round" class="block text-sm font-medium text-gray-700">ラウンド</label>
                                <input type="text" id="round" name="round" placeholder="1R" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <!-- プレイヤー名 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="player1_1" class="block text-sm font-medium text-gray-700">味方（あなた）</label>
                                <input type="text" id="player1_1" name="player1_1" value="あなた" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="player1_2" class="block text-sm font-medium text-gray-700">味方（パートナー）</label>
                                <input type="text" id="player1_2" name="player1_2" placeholder="パートナー名" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="player2_1" class="block text-sm font-medium text-gray-700">相手</label>
                                <input type="text" id="player2_1" name="player2_1" placeholder="相手1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="player2_2" class="block text-sm font-medium text-gray-700">相手</label>
                                <input type="text" id="player2_2" name="player2_2" placeholder="相手2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <!-- ルール設定 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700">セット数</label>
                            <div class="mt-1 grid grid-cols-3 gap-2">
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="sets" value="1" class="form-radio text-blue-600 focus:ring-blue-500" checked>
                                    <span class="text-sm">1</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="sets" value="3" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm">3</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="sets" value="5" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm">5</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">ゲーム数</label>
                            <div class="mt-1 grid grid-cols-3 gap-2">
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="games" value="4" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm">4</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="games" value="6" class="form-radio text-blue-600 focus:ring-blue-500" checked>
                                    <span class="text-sm">6</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="games" value="8" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm">8</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">タイブレーク</label>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="tiebreak" value="なし" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm">なし</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="tiebreak" value="6-6" class="form-radio text-blue-600 focus:ring-blue-500" checked>
                                    <span class="text-sm">6-6</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">デュース</label>
                            <div class="mt-1 grid grid-cols-3 gap-2">
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="deuce" value="あり" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm">あり</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="deuce" value="ノーアド" class="form-radio text-blue-600 focus:ring-blue-500" checked>
                                    <span class="text-sm">ノーアド</span>
                                </label>
                                <label class="flex items-center space-x-2 bg-gray-200 rounded-md p-2">
                                    <input type="radio" name="deuce" value="セミアド" class="form-radio text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm">セミアド</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="btn w-full bg-blue-600 text-white font-bold py-3 rounded-full hover:bg-blue-700">試合開始</button>
                    </form>
                    <button onclick="navigate('home')" class="btn w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-full hover:bg-gray-300 mt-4">戻る</button>
                </div>
            `,
            match: `
                <div class="main-card p-6 md:p-8 space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">試合記録</h2>
                    <div id="serverDisplay" class="text-center text-lg font-medium text-gray-700 mb-4">
                        <!-- サーバー名または選択画面が表示されます -->
                    </div>
                    
                    <div id="scoreDisplay" class="text-center font-bold text-4xl space-y-4">
                        <div class="flex justify-around items-center">
                            <span class="text-gray-800">Sets</span>
                            <span class="text-blue-600" id="setScore">0 - 0</span>
                        </div>
                        <div class="flex justify-around items-center">
                            <span class="text-gray-800">Games</span>
                            <span class="text-blue-600" id="gameScore">0 - 0</span>
                        </div>
                        <div class="flex justify-around items-center">
                            <span class="text-gray-800">Points</span>
                            <span class="text-blue-600" id="pointScore">0 - 0</span>
                        </div>
                    </div>

                    <!-- ショットと勝敗の選択 -->
                    <div id="shotInput" class="space-y-4">
                        <h3 class="text-xl font-semibold text-center mt-6">最後のショット</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button class="shot-btn btn bg-gray-200 text-gray-800 p-4 rounded-xl font-medium" data-shot="フォアハンド">フォアハンド</button>
                            <button class="shot-btn btn bg-gray-200 text-gray-800 p-4 rounded-xl font-medium" data-shot="バックハンド">バックハンド</button>
                            <button class="shot-btn btn bg-gray-200 text-gray-800 p-4 rounded-xl font-medium" data-shot="ボレー">ボレー</button>
                            <button class="shot-btn btn bg-gray-200 text-gray-800 p-4 rounded-xl font-medium" data-shot="スマッシュ">スマッシュ</button>
                            <button class="shot-btn btn bg-gray-200 text-gray-800 p-4 rounded-xl font-medium" data-shot="サーブ">サーブ</button>
                            <button class="shot-btn btn bg-gray-200 text-gray-800 p-4 rounded-xl font-medium" data-shot="その他">その他</button>
                        </div>
                        <h3 class="text-xl font-semibold text-center mt-6">ポイント獲得者</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button class="winner-btn btn bg-green-500 text-white p-4 rounded-xl font-bold" data-winner="team1">自分チーム</button>
                            <button class="winner-btn btn bg-red-500 text-white p-4 rounded-xl font-bold" data-winner="team2">相手チーム</button>
                        </div>
                    </div>

                    <div class="mt-8 flex justify-between space-x-4">
                        <button onclick="endMatch()" class="btn bg-red-600 text-white font-bold py-3 px-6 rounded-full hover:bg-red-700">試合終了</button>
                        <button onclick="undoPoint()" class="btn bg-yellow-500 text-white font-bold py-3 px-6 rounded-full hover:bg-yellow-600">アンドゥ</button>
                    </div>
                </div>
            `,
            history: `
                <div class="main-card p-6 md:p-8 space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center">試合履歴</h2>
                    <ul id="historyList" class="space-y-4">
                        <!-- History items will be rendered here -->
                    </ul>
                    <button onclick="navigate('home')" class="btn w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-full hover:bg-gray-300">戻る</button>
                </div>
            `,
            analysis: `
                <div class="main-card p-6 md:p-8 space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800 text-center">試合分析</h2>
                    <div id="analysisContent" class="space-y-4">
                        <!-- Analysis content will be rendered here -->
                    </div>
                    <button onclick="navigate('history')" class="btn w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-full hover:bg-gray-300">戻る</button>
                </div>
            `
        };

        const scoreMap = ['0', '15', '30', '40'];

        // アプリのナビゲーションを管理する関数
        function navigate(page, data = null) {
            state.currentPage = page;
            const app = document.getElementById('app');
            app.innerHTML = pages[page];
            
            // ページに応じた初期化処理
            if (page === 'setup') {
                document.getElementById('setupForm').addEventListener('submit', handleSetupFormSubmit);
            } else if (page === 'match') {
                initializeMatchPage();
            } else if (page === 'history') {
                renderHistory();
            } else if (page === 'analysis') {
                renderAnalysis(data);
            }
        }

        // 試合設定フォームの送信ハンドラ
        function handleSetupFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const matchData = {
                id: Date.now(),
                date: formData.get('date'),
                tournament: formData.get('tournament'),
                round: formData.get('round'),
                players: {
                    team1: [formData.get('player1_1'), formData.get('player1_2')],
                    team2: [formData.get('player2_1'), formData.get('player2_2')]
                },
                rules: {
                    sets: parseInt(formData.get('sets')),
                    games: parseInt(formData.get('games')),
                    tiebreak: formData.get('tiebreak'),
                    deuce: formData.get('deuce')
                },
                score: {
                    sets: [[0, 0], [0, 0], [0, 0], [0, 0], [0, 0]],
                    games: [0, 0],
                    points: ['0', '0']
                },
                pointsLog: [],
                currentServerIndex: null, // サーバーは手動で選択されるまでnull
                game1ServerIndex: null,   // 1ゲーム目のサーバーを保存
                game2ServerIndex: null    // 2ゲーム目のサーバーを保存
            };

            state.matchData = matchData;
            state.players = matchData.players;
            state.score = matchData.score;
            navigate('match');
        }

        // 試合ページ初期化
        function initializeMatchPage() {
            document.querySelectorAll('.shot-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.shot-btn').forEach(b => b.classList.remove('selected-btn'));
                    e.target.classList.add('selected-btn');
                    state.currentShot = e.target.dataset.shot;
                    checkAndRecordPoint();
                });
            });

            document.querySelectorAll('.winner-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.winner-btn').forEach(b => b.classList.remove('selected-btn'));
                    e.target.classList.add('selected-btn');
                    state.currentPointWinner = e.target.dataset.winner;
                    checkAndRecordPoint();
                });
            });

            updateScoreDisplay();
            updateServerDisplay();
        }

        // サーバーを手動で選択する関数
        function selectServer(serverIndex) {
            const totalGames = state.matchData.score.games[0] + state.matchData.score.games[1];
            
            // 1ゲーム目または2ゲーム目のサーバーを記録
            if (totalGames === 0) {
                state.matchData.game1ServerIndex = serverIndex;
            } else if (totalGames === 1) {
                state.matchData.game2ServerIndex = serverIndex;
            }

            state.matchData.currentServerIndex = serverIndex;
            updateServerDisplay();
        }

        // サーバー選択画面を表示する関数
        function showServerSelection() {
            const serverDisplay = document.getElementById('serverDisplay');
            const players = state.matchData.players;
            
            // サーバー選択画面のHTMLを生成
            serverDisplay.innerHTML = `
                <div class="main-card p-4 md:p-6 space-y-4">
                    <h3 class="text-xl font-semibold text-center mb-2">サーバーを選択</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="selectServer(0)" class="btn bg-blue-500 text-white p-2 rounded-lg font-bold">${players.team1[0]}</button>
                        <button onclick="selectServer(2)" class="btn bg-blue-500 text-white p-2 rounded-lg font-bold">${players.team1[1]}</button>
                        <button onclick="selectServer(1)" class="btn bg-red-500 text-white p-2 rounded-lg font-bold">${players.team2[0]}</button>
                        <button onclick="selectServer(3)" class="btn bg-red-500 text-white p-2 rounded-lg font-bold">${players.team2[1]}</button>
                    </div>
                    <button onclick="resetServerSelection()" class="btn w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-full hover:bg-gray-300">戻る</button>
                </div>
            `;
        }

        // サーバー選択をリセットする関数
        function resetServerSelection() {
            state.matchData.currentServerIndex = null;
            updateServerDisplay();
        }

        // ポイントを記録し、スコアを更新
        function checkAndRecordPoint() {
            if (state.currentShot && state.currentPointWinner) {
                // サーバーが未選択の場合は何もしない
                if (state.matchData.currentServerIndex === null) {
                    showCustomMessage('サーバーを選択してください。', 'OK');
                    return;
                }

                // ポイントログに追加
                state.matchData.pointsLog.push({
                    shot: state.currentShot,
                    winner: state.currentPointWinner
                });

                // スコアを更新
                updateScore(state.currentPointWinner);

                // ボタンの状態をリセット
                document.querySelectorAll('.shot-btn, .winner-btn').forEach(btn => btn.classList.remove('selected-btn'));
                state.currentShot = null;
                state.currentPointWinner = null;
            }
        }

        // Helper function to show a custom message box
        function showCustomMessage(message, buttonText, onButtonClick) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl z-50';
            messageBox.innerHTML = `
                <p class="text-center text-lg font-semibold mb-4">${message}</p>
                <button class="w-full bg-blue-600 text-white font-bold py-2 rounded-full hover:bg-blue-700">${buttonText}</button>
            `;
            document.body.appendChild(messageBox);
            
            messageBox.querySelector('button').addEventListener('click', () => {
                messageBox.remove();
                if (onButtonClick) {
                    onButtonClick();
                }
            });
        }

        // スコア更新ロジック
        function updateScore(winner) {
            const rules = state.matchData.rules;
            const currentSetIndex = state.matchData.score.sets.findIndex(([g1, g2]) => g1 < rules.games && g2 < rules.games);
            
            // 現在のゲームスコア
            let [p1, p2] = state.matchData.score.points;

            if (winner === 'team1') {
                if (p1 === '40') {
                    // Game to team 1
                    state.matchData.score.games[0]++;
                    state.matchData.score.points = ['0', '0'];
                    updateServer();
                } else {
                    state.matchData.score.points[0] = scoreMap[scoreMap.indexOf(p1) + 1] || p1;
                }
            } else {
                if (p2 === '40') {
                    // Game to team 2
                    state.matchData.score.games[1]++;
                    state.matchData.score.points = ['0', '0'];
                    updateServer();
                } else {
                    state.matchData.score.points[1] = scoreMap[scoreMap.indexOf(p2) + 1] || p2;
                }
            }
            
            updateScoreDisplay();
        }

        // サーバーのパートナーのインデックスを取得するヘルパー関数
        function getPartnerIndex(index) {
            if (index === 0) return 2; // Team 1, Player 1's partner
            if (index === 2) return 0; // Team 1, Player 2's partner
            if (index === 1) return 3; // Team 2, Player 1's partner
            if (index === 3) return 1; // Team 2, Player 2's partner
            return null;
        }

        // サーバーを更新するロジック
        function updateServer() {
            const totalGames = state.matchData.score.games[0] + state.matchData.score.games[1];
            
            if (totalGames < 2) {
                // 1ゲーム目と2ゲーム目は手動選択のまま
                state.matchData.currentServerIndex = null;
            } else {
                // 3ゲーム目以降は自動的に切り替え
                let newServerIndex;
                const game1Server = state.matchData.game1ServerIndex;
                const game2Server = state.matchData.game2ServerIndex;

                // サーバーの回転順序
                // 1ゲーム目: game1Server
                // 2ゲーム目: game2Server
                // 3ゲーム目: game1Server のペア
                // 4ゲーム目: game2Server のペア
                // 5ゲーム目: game1Server
                // ...というサイクル
                
                const gameInCycle = totalGames % 4; // 0, 1, 2, 3 の繰り返し

                if (gameInCycle === 0) { // 4ゲーム目、8ゲーム目... (3ゲーム終わって次のゲーム)
                    newServerIndex = game1Server;
                } else if (gameInCycle === 1) { // 1ゲーム目、5ゲーム目... (0ゲーム終わって次のゲーム)
                    newServerIndex = game2Server;
                } else if (gameInCycle === 2) { // 2ゲーム目、6ゲーム目... (1ゲーム終わって次のゲーム)
                    newServerIndex = getPartnerIndex(game1Server);
                } else if (gameInCycle === 3) { // 3ゲーム目、7ゲーム目... (2ゲーム終わって次のゲーム)
                    newServerIndex = getPartnerIndex(game2Server);
                }
                
                state.matchData.currentServerIndex = newServerIndex;
            }
            updateServerDisplay();
        }

        // スコア表示を更新
        function updateScoreDisplay() {
            const setScore = state.matchData.score.sets.map(s => s.join('-')).join(', ');
            const gameScore = state.matchData.score.games.join(' - ');
            const pointScore = state.matchData.score.points.join(' - ');

            document.getElementById('setScore').textContent = setScore;
            document.getElementById('gameScore').textContent = gameScore;
            document.getElementById('pointScore').textContent = pointScore;
        }

        // サーバー名を表示を更新
        function updateServerDisplay() {
            const serverDisplay = document.getElementById('serverDisplay');
            const currentServerIndex = state.matchData.currentServerIndex;
            const totalGames = state.matchData.score.games[0] + state.matchData.score.games[1];

            // 最初の2ゲームでサーバーが未選択、または3ゲーム目以降でサーバーがnullの場合は選択画面を表示
            if (currentServerIndex === null && totalGames < 2) {
                showServerSelection();
            } else {
                // サーバーが選択されている場合はサーバー名を表示
                const players = state.matchData.players;
                let serverName = "";
                if (currentServerIndex === 0) {
                    serverName = players.team1[0];
                } else if (currentServerIndex === 1) {
                    serverName = players.team2[0];
                } else if (currentServerIndex === 2) {
                    serverName = players.team1[1];
                } else if (currentServerIndex === 3) {
                    serverName = players.team2[1];
                }
                serverDisplay.innerHTML = `<span class="font-bold text-xl">サーバー: ${serverName}</span>`;
            }
        }

        // 試合を終了し、データを保存
        function endMatch() {
            if (state.matchData) {
                state.history.push(state.matchData);
                saveDataToLocalStorage();
                showCustomMessage('試合が終了し、データが保存されました！', 'OK', () => navigate('home'));
            }
        }

        // ポイントのアンドゥ機能
        function undoPoint() {
            showCustomMessage('アンドゥ機能は未実装です。', 'OK');
        }

        // データをローカルストレージに保存
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('tennis_app_data', JSON.stringify(state.history));
            } catch (e) {
                console.error("ローカルストレージへの保存に失敗しました。", e);
            }
        }

        // データをローカルストレージから読み込み
        function loadDataFromLocalStorage() {
            try {
                const data = localStorage.getItem('tennis_app_data');
                if (data) {
                    state.history = JSON.parse(data);
                }
            } catch (e) {
                console.error("ローカルストレージからの読み込みに失敗しました。", e);
                state.history = [];
            }
        }

        // 履歴ページのレンダリング
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            historyList.innerHTML = '';
            
            if (state.history.length === 0) {
                historyList.innerHTML = '<li class="text-center text-gray-500">試合履歴がありません。</li>';
                return;
            }

            state.history.forEach(match => {
                const li = document.createElement('li');
                li.className = 'bg-gray-50 p-4 rounded-lg shadow-sm flex justify-between items-center';
                li.innerHTML = `
                    <div>
                        <p class="text-lg font-bold text-gray-800">${match.tournament || '大会名なし'}</p>
                        <p class="text-sm text-gray-500">${match.date}</p>
                        <p class="text-sm text-gray-600">${match.players.team1.join(' & ') || '自分'} vs ${match.players.team2.join(' & ') || '相手'}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="navigate('analysis', ${match.id})" class="btn bg-blue-500 text-white text-sm px-4 py-2 rounded-full hover:bg-blue-600">分析</button>
                    </div>
                `;
                historyList.appendChild(li);
            });
        }

        // 分析ページのレンダリング
        function renderAnalysis(matchId) {
            const match = state.history.find(m => m.id === matchId);
            const analysisContent = document.getElementById('analysisContent');
            if (!match || !analysisContent) return;

            // ショットごとのポイント獲得数を集計
            const shotCounts = {};
            const winnerShotCounts = { team1: {}, team2: {} };
            
            match.pointsLog.forEach(log => {
                shotCounts[log.shot] = (shotCounts[log.shot] || 0) + 1;
                winnerShotCounts[log.winner][log.shot] = (winnerShotCounts[log.winner][log.shot] || 0) + 1;
            });

            let analysisHtml = `<h3 class="text-xl font-semibold mb-4">試合サマリー</h3>`;
            analysisHtml += `<p class="text-gray-700">総ポイント数: ${match.pointsLog.length}</p>`;
            
            analysisHtml += `<h3 class="text-xl font-semibold mt-6 mb-4">ショット分析</h3>`;
            analysisHtml += `<div class="bg-gray-50 p-4 rounded-lg shadow-sm space-y-2">`;
            for (const shot in shotCounts) {
                const team1Count = winnerShotCounts.team1[shot] || 0;
                const team2Count = winnerShotCounts.team2[shot] || 0;
                const total = team1Count + team2Count;
                analysisHtml += `<p class="text-gray-700">${shot}: ${total}回 (自分チーム: ${team1Count}, 相手チーム: ${team2Count})</p>`;
            }
            analysisHtml += `</div>`;
            
            analysisContent.innerHTML = analysisHtml;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            navigate('home');
        });

    </script>
</body>
</html>
